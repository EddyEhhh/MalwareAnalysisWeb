<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xml:lang="en">

    <ui:composition template="/template/user_default.xhtml">
        <ui:define name="pageTitle">#{msg["header.allRole"]}</ui:define>
        <ui:define name="body">
            <h:body>
                <br/>
                <h:form id="roleForm">
                    <p:growl globalOnly="true"/>
                    <p:dataTable widgetVar="dtRoles" var="thisRole" value="#{viewOrganisationRoleBean.roles}" rowKey="#{thisRole.suuid}" selectionMode="single"
                                 emptyMessage="No Roles Found with the Given Criteria"
                                 filteredValue="#{viewOrganisationRoleBean.filteredRoles}"
                                 globalFilterFunction="#{viewOrganisationRoleBean.globalFilterFunction}"
                                 rows="10"
                                 paginator="true"
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                 currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} records"
                                 rowsPerPageTemplate="5,10,{ShowAll|'All'}"
                                 draggableColumns="true"
                                 resizableColumns="true">
                        <f:facet name="header">
                            <div class="products-table-header grid">
                                <div class="col-8">
                                    <span class="font-bold text-3xl">#{msg["role.title"]}</span>
                                </div>
                                <div class="col-1">
                                    <p:commandButton rendered="#{uIPermission.createRole}" class="mx-5 px-1 ui-button-raised ui-button-help" value="#{msg['general.new']}" icon="pi pi-plus" onclick="PF('addRoleDialog').show()"/>
                                </div>
                                <div class="col-3">
                                    <div class="p-d-flex p-jc-end">
                                        <p:inputText id="globalFilter" class="shadow-2" onkeyup="PF('dtRoles').filter()" style="width:350px"
                                                     placeholder="Search" />
                                    </div>
                                </div>
                            </div>
                        </f:facet>
                        <p:column class="text-lg w-3" headerText="#{msg['role.name']}" sortBy="#{thisRole.name}">
                            <h:outputText value="#{thisRole.name}" />
                        </p:column>
                        <p:column class="text-lg w-3" headerText="#{msg['role.description']}">
                            <h:outputText value="#{thisRole.description}" />
                        </p:column>
                        <p:column class="text-lg w-3" headerText="#{msg['role.user']}">
                            <h:outputText value="#{viewOrganisationRoleBean.numberOfMemberInRole(thisRole.suuid)}" />
                        </p:column>

                        <!--Buttons -->
                        <p:column>     
                            <p:commandButton rendered="#{uIPermission.viewRoleDetail}" id="viewRole" icon="pi pi-search" action="#{redirectBean.viewRole()}" class="rounded-button ui-button-info ui-button-flat">
                                <f:param name="id" value="#{thisRole.suuid}"/>
                                 <p:tooltip for="viewRole" value="#{msg['role.viewRole']}" position="bottom"/>
                            </p:commandButton>
                            <p:commandButton rendered="#{uIPermission.editRole}" id="editRole" icon="pi pi-pencil" action="#{redirectBean.editRole()}" class="rounded-button ui-button-warning ui-button-flat">
                                <f:param name="id" value="#{thisRole.suuid}"/>
                                 <p:tooltip for="editRole" value="#{msg['role.editRole']}" position="bottom"/>
                            </p:commandButton>
                            <p:commandButton rendered="#{uIPermission.deleteRole}" id="deleteRole" icon="pi pi-trash" styleClass="rounded-button ui-button-danger ui-button-flat" action="#{deleteRoleBean.openDeleteDialog(thisRole)}" update="deleteRoleForm" >
                                 <p:tooltip for="deleteRole" value="#{role.deleteRole}" position="bottom"/>
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
<!--                    <p:blockUI block="roleDataTable" trigger="roleDataTable">
                        <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
                    </p:blockUI>-->

                </h:form>
                <h:form id="deleteRoleForm">
                    <!--Delete Role confirmation-->
                    <p:confirmDialog widgetVar="deleteRoleDialog" showEffect="fade" width="300"
                                     message="Delete role: #{deleteRoleBean.selectedRoleDTO.name}" header="#{msg['general.confirm']}" severity="warn">
                         <p:commandButton value="#{msg['general.no']}" type="button" styleClass="ui-button-raised ui-button-secondary ui-button-flat" icon="pi pi-times" onclick="PF('deleteRoleDialog').hide();"/>
                        <p:commandButton value="#{msg['general.yes']}" icon="pi pi-check" styleClass="ui-button-raised ui-button-help" action="#{deleteRoleBean.delete}" update="roleForm"
                                         onclick= "PF('deleteRoleDialog').hide();"/>
                    </p:confirmDialog>
                </h:form>


                <!--Create Roles Dialog-->
                <h:form id="createRoleForm">
                    <p:dialog id="addRoleDialog" maximizable="true" header="#{msg['role.createRole']}" widgetVar="addRoleDialog" minHeight="40" height="500" width="900" showEffect="fade" modal="true" minimizable="true" style="text-align:left" responsive="true">
                        <p:ajax event="maximize" update="permissionScrollPanel"/>
                        <p:ajax event="restoreMaximize" update="permissionScrollPanel"/>
                        <p:remoteCommand name="updateMultiple" update="selectItemPermission multiple selectPermissionCheckbox indirectInheritance" />
                        <p:outputPanel id="createRolePanel" class="ui-fluid">
                            <div class="grid">
                                <div class="col">
                                    <p:outputLabel for="name" class="font-bold">#{msg['role.name']}</p:outputLabel>
                                    <p:inputText id="name" value="#{createOrganiastionRoleBean.roleDTO.name}"/>
                                    <p:message for="name" id="nameMsg"/>
                                </div>
                                <div class="col">
                                    <p:outputLabel class="flex font-bold">#{msg["member.role"]}</p:outputLabel>
                                    <p:selectCheckboxMenu id="multiple" value="#{createOrganiastionRoleBean.selectedRole}" label="Roles" style="min-width: 15rem"
                                                          multiple="true" converterMessage="Converter Error" filter="true" filterMatchMode="startsWith" panelStyle="width: 30rem" scrollHeight="250" class="overflow-y-scroll">
                                        <f:selectItems id="selectItem"
                                                       itemDisabled="#{createOrganiastionRoleBean.containsName(createOrganiastionRoleBean.indirectInheritedRole, thisRole.suuid)}" 
                                                       noSelectionValue="#{!createOrganiastionRoleBean.containsName(createOrganiastionRoleBean.indirectInheritedRole, thisRole.suuid)}" 
                                                       value="#{createOrganiastionRoleBean.availableRoles}" var="thisRole" itemLabel="#{thisRole.name}" itemValue="#{thisRole}"/>
                                        <p:ajax id="checkboxAjax" oncomplete="updateMultiple();" update="selectPermissionCheckbox" event="change" listener="#{createOrganiastionRoleBean.onSelectRole()}" />
                                    </p:selectCheckboxMenu>
                                </div>
                            </div>
                            <div class="p-field">
                                <p:outputPanel id="indirectInheritance">
                                    <p:outputLabel class="flex font-bold">#{msg["member.indirectInheritance"]}</p:outputLabel>
                                    <p:card class="bg-auto bg-primary-reverse">
                                        <p:repeat value="#{createOrganiastionRoleBean.indirectInheritedRole}" var="indirectInheritRole">
                                            <p:chip label="#{indirectInheritRole.name}" styleClass="p-mr-2"/>
                                        </p:repeat>
                                    </p:card>
                                </p:outputPanel>
                            </div>
                            <br/>
                            <div class="p-field">
                                <p:outputLabel for="description" class="font-bold">#{msg['role.description']}</p:outputLabel>
                                <p:inputTextarea id="description" class="h-3rem" value="#{createOrganiastionRoleBean.roleDTO.description}"/>
                                <p:message for="description" id="descriptionMsg"/>
                            </div>
                        <div class="p-field">
                                <p:outputLabel class="font-bold">Permissions</p:outputLabel>
                                <p:scrollPanel id="permissionScrollPanel" class="w-auto h-15rem grid">
<!--                                    <p:repeat value="#{createOrganiastionRoleBean.availablePermission.keySet()}" var="thisCategory" varStatus="selectPermissionStatus">-->
                                             <div class="col-6">
<!--                                            <p:outputLabel for="selectPermissionCheckbox"><b>#{thisCategory}</b></p:outputLabel>-->
                                                 <p:selectManyCheckbox id="selectPermissionCheckbox" value="#{createOrganiastionRoleBean.selectedPermission}" layout="responsive"
                                                                   columns="1">
                                                <f:selectItems id="selectItemPermission" value="#{createOrganiastionRoleBean.availablePermission}" var="thisPerm" 
                                                               itemLabel="#{thisPerm.name}  #{createOrganiastionRoleBean.containsPermissionSuuid(createOrganiastionRoleBean.inheritedPermission, thisPerm.suuid)? '(Inherited)' : null}" itemValue="#{thisPerm}"
                                                               itemDescription="#{thisPerm.description}"
                                                               />
                                                <p:ajax update="selectPermissionCheckbox" listener="#{createOrganiastionRoleBean.onSelectRole()}"/>
                                                </p:selectManyCheckbox>
                                                </div>
<!--                                            </p:repeat>-->
  
                                </p:scrollPanel>
                        </div>
                            <p:growl globalOnly="true" id="createRoleMessage"/>
                            <div id="loadingText" style="font-weight:bold; margin:5px 0 5px 0; visibility:hidden;">
                                <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i> #{msg['role.creatingRole']}
                            </div>
                        </p:outputPanel>
                        <f:facet name="footer" class="py-1">
                             <p:commandButton value="#{msg['general.cancel']}" icon="pi pi-times" onclick="PF('addRoleDialog').hide()" class="ui-button-raised ui-button-secondary ui-button-flat"/>
                            <p:commandButton value="#{msg['general.create']}" icon="pi pi-check" update="createRolePanel errorGrowl" action="#{createOrganiastionRoleBean.createRole}" 
                                              class="ui-button-raised ui-button-help"
                                             oncomplete="$('#loadingText').css('visibility', 'hidden'), updateMultiple();" onclick="$('#loadingText').css('visibility', 'visible')"/>  
                        </f:facet>
                        <p:growl id="errorGrowl"/>
                    </p:dialog>
                </h:form>
            </h:body>
        </ui:define>
    </ui:composition>
</html>
