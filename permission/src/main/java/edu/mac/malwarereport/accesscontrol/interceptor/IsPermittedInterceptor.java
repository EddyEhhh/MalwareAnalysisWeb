/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package edu.mac.malwarereport.accesscontrol.interceptor;

import edu.mac.malwarereport.accesscontrol.service.permission.RolePermission;
import edu.mac.malwarereport.ownership.outputinfo.MappingStatus;
import edu.mac.malwarereport.permission.data.CategoryFacade;
import edu.mac.malwarereport.permission.data.PermissionFacade;
import edu.mac.malwarereport.permission.entity.Category;
import edu.mac.malwarereport.permission.entity.Permission;
import edu.mac.malwarereport.permission.outputInfo.PermissionStatus;
import jakarta.inject.Inject;
import jakarta.interceptor.AroundInvoke;
import jakarta.interceptor.Interceptor;
import jakarta.interceptor.InvocationContext;
import java.util.Arrays;

/**
 *
 * @author E
 */
@IsPermitted
@Interceptor
public class IsPermittedInterceptor {

    @Inject
    private RolePermission rolePermission;
    
    @Inject
    private PermissionFacade permissionFacade;
    
    @Inject
    private CategoryFacade categoryFacade;

    public IsPermittedInterceptor() {

    }

    //ADD CHECK PERMISSION 
    //Checks if user is from the same organisation
    @AroundInvoke
    public Object IsPermitted(InvocationContext ctx) throws Exception {
        //get staffDTO parameter
        String functionLabel = Arrays.asList(Arrays.asList(ctx.getMethod().toGenericString().split(" ")).get(2).split("\\(")).get(0);
        for(Permission eachPermission : rolePermission.getAccountPermission()){
//            System.out.print("Checking: " + eachPermission.getName());
//            System.out.print("Compare: " + eachPermission.getLabel() + "  " + functionLabel);
            if(eachPermission.getLabel().equalsIgnoreCase(functionLabel)){
//                System.out.print("Granted");
                return ctx.proceed();
            }
        }
//        System.out.print("Denied");
        return null;

    }
    
//    public Object Test(InvocationContext ctx) throws Exception {
//        //get staffDTO parameter
//        String functionLabel = Arrays.asList(Arrays.asList(ctx.getMethod().toGenericString().split(" ")).get(2).split("\\(")).get(0);
//        Category category = new Category("REMOVE");
//        
//        Permission permission = new Permission("NAME", functionLabel, category, "UNDEFINED", 1, "DESCRIPTION");
//        permissionFacade.create(permission);
////        Object[] parameters = ctx.getParameters();
////        Long organisationId = (long) parameters[0];
////        Long accountId = authenticate.getCurrentAccount().getId();
////        OwnershipAssignment ownershipAssignment = new OwnershipAssignment(organisationId, "org", accountId, "acc");
////        if(ownershipAssignmentManager.isMapped(ownershipAssignment)){
//            return ctx.proceed();
////        }
////            return MappingStatus.FAILURE;
//    }

}
